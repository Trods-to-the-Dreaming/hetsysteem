{{#block "title"}}Gebouwen beheren{{/block}}

{{#block "headScripts"}}
<script type="module">
	import { turn } from '/js/turn-logic.js';
	turn.page.index = 1;
	turn.page.checkAccess();
</script>
{{/block}}

<div id="container-div" class="container-compact d-none">
	<h1>Gebouwen beheren</h1>
	
	<div id="demolish-div" class="field">
		<h2>ğŸ’¥ Slopen</h2>
		
		<button id="open-demolish-window-button" class="button-2" type="button" 
				data-bs-toggle="offcanvas" data-bs-target="#demolish-window">
			Bestaand gebouw slopen
		</button>
		
		<ul id="demolish-ul" class="list-compact d-none"></ul>
	</div>
	
	<div id="build-div" class="field">
		<h2>ğŸ—ï¸ Bouwen</h2>

		<p>Vrije landtegels: <span id="unoccupied-tiles-span"></span></p>
		
		<button id="open-construct-window-button" class="button-2" type="button" 
				data-bs-toggle="offcanvas" data-bs-target="#construct-window">
			Nieuwbouw plaatsen
		</button>
		
		<ul id="construct-ul" class="list-compact d-none"></ul>
	</div>
	
	<hr>
</div>

<div id="demolish-window" class="offcanvas offcanvas-start" data-bs-backdrop="true" data-bs-scroll="false" tabindex="-1">
	<div class="offcanvas-header">
		<h2>ğŸ’¥ Slopen</h2>
		
		<button class="btn-close" type="button" data-bs-dismiss="offcanvas" aria-label="Sluiten"></button>
	</div>
	
	<div class="offcanvas-body">
		<p>Vink de te slopen gebouwen aan.</p>
		
		<div id="existing-buildings-div" class="field"></div>
		
		<div class="container-compact">
			<button id="confirm-demolish-button" class="button-2" type="button">Bevestigen</button>
		</div>
	</div>
</div>

<div id="construct-window" class="offcanvas offcanvas-start" data-bs-backdrop="true" data-bs-scroll="false" tabindex="-1">
	<div class="offcanvas-header">
		<h2>ğŸ—ï¸ Bouwen</h2>
		
		<button class="btn-close" type="button" data-bs-dismiss="offcanvas" aria-label="Sluiten"></button>
	</div>
	
	<div class="offcanvas-body">
		<div class="field">
			<label for="new-building-select" class="form-label">Kies een gebouw.</label>
			<select id="new-building-select" class="form-select" type="text" required></select>
		</div>
		
		<div class="field">
			<label for="size-select" class="form-label">Kies een grootte.</label>
			<select id="size-select" class="form-select" type="text" required></select>
		</div>
		
		<div class="container-compact">
			<button id="confirm-construct-button" class="button-2" type="button">Bevestigen</button>
		</div>
	</div>
</div>

<script type="module">
import { turn } from '/js/turn-logic.js';

//--- Initialize elements -----------------------------------------------------------------------//
turn.page.initializeElements = function() {
	const characterState = JSON.parse(localStorage.getItem(`turn.characterState`));
	const buildings = JSON.parse(localStorage.getItem(`turn.buildings`));
	
	if (!turn.page.action) {
		turn.page.action = {
			demolish: [],
			construct: []
		};
	}
	
	turn.page.elements = {
		demolish: document.getElementById('demolish-ul'),
		construct: document.getElementById('construct-ul'),
		demolishOffcanvas: new bootstrap.Offcanvas(
			document.getElementById('demolish-window')
		),
		constructOffcanvas: new bootstrap.Offcanvas(
			document.getElementById('construct-window')
		),
		confirmDemolish: document.getElementById('confirm-demolish-button'),
		confirmConstruct: document.getElementById('confirm-construct-button'),
		unoccupiedTiles: document.getElementById('unoccupied-tiles-span'),
		existingBuildings: document.getElementById('existing-buildings-div'),
		newBuilding: document.getElementById('new-building-select'),
		size: document.getElementById('size-select')
	};
	
	const action = turn.page.action;
	const elements = turn.page.elements;
	
	turn.page.populateSelect(elements.newBuilding, buildings, 'type');
	
	let occupiedTiles = 0;
	
	const existingBuildings = characterState.ownedBuildings.map(eb => {
		const building = buildings.find(b => b.id === eb.buildingId);
		const isDemolished = action.demolish.includes(eb.buildingId);
		const size = building.baseSize * eb.sizeFactor;
		const unit = size === 1 ? 'tegel' : 'tegels';
		
		occupiedTiles += isDemolished ? 0 : size;

		return {
			id: eb.buildingId,
			isDemolished,
			size,
			descriptionHTML: `${eb.name} <small>(${building.type} ${size} ${unit})</small>`
		};
	});
	
	const newBuildings = action.construct.map(nb => {
		const building = buildings.find(b => b.id === cb.buildingId);
		const size = building.baseSize * nb.sizeFactor;
		const unit = size === 1 ? 'tegel' : 'tegels';
		
		occupiedTiles += size;
		
		return {
			size,
			descriptionHTML: `${nb.name} <small>(${building.type} ${size} ${unit})</small>`
		};
	});
	
	turn.page.data = {
		unoccupiedTiles: characterState.ownedTiles - occupiedTiles,
		existingBuildings,
		newBuildings
	};
	
	elements.confirmDemolish.addEventListener('click', handleConfirmDemolish);
	elements.confirmConstruct.addEventListener('click', handleConfirmConstruct);
	
	updateUI();
	
	/*const offcanvas = document.getElementById('demolish-window');

	offcanvas.addEventListener('show.bs.offcanvas', () => {
		const maxSize = 1;

		turn.page.helpers.ownedBuildings.forEach(ob => {
			if (ob.size > maxSize) {
				const option = elements.ownedBuildings.querySelector(`option[value="${ob.id}"]`);
				option.disabled = true;
			}
		});
	});*/
}

//--- Read elements -----------------------------------------------------------------------------//
turn.page.readElements = function() {
	const action = turn.page.action;
	const elements = turn.page.elements;
	
	//action.demolish = Array.from(elements.demolish.querySelectorAll('li'))
	//	.map(li => Number(li.dataset.buildingId));

	
}

//--- Server check ------------------------------------------------------------------------------//
turn.page.beforeNext = async function() {
	/*const nameError = document.getElementById('name-error');
	nameError.textContent = '';
	
	const elements = turn.page.elements;
	const firstName = elements.firstName.value;
	const lastName = elements.lastName.value;

	try {
		const params = new URLSearchParams({
			firstName,
			lastName,
		});
		const res = await fetch(`/game/turn/check-character-name?${params}`);
		const { available } = await res.json();

		if (!available) {
			nameError.textContent = 'Deze naam is al in gebruik.';
			return false;
		}
		
		return true;
	} catch (err) {
		console.error(err);
		return false;
	}*/
};

//--- Event handlers ----------------------------------------------------------------------------//
function handleConfirmDemolish() {
	const elements = turn.page.elements;
	const data = turn.page.data;

	const checkboxes = elements.existingBuildings.querySelectorAll('input[type="checkbox"]');

	checkboxes.forEach(checkbox => {
		const buildingId = parseInt(checkbox.dataset.buildingId, 10);
		const building = data.existingBuildings.find(b => b.id === buildingId);
		building.isDemolished = checkbox.checked;
	});
	
	updateUI();
	elements.demolishOffcanvas.hide();
}

function handleConfirmConstruct() {
	// geselecteerde value van newBuilding (id) en size (ook id?) ophalen
	
	updateUI();
}

//--- Helpers -----------------------------------------------------------------------------------//
function updateUI() {
	const elements = turn.page.elements;
	const data = turn.page.data;
	
	renderDemolishList();
	renderConstructList();
	renderUnoccupiedTiles();
}

function renderDemolishList() {
	const elements = turn.page.elements;
	const data = turn.page.data;
	
	elements.demolish.innerHTML = '';
	elements.existingBuildings.innerHTML = '';
	
	data.existingBuildings.forEach(eb => {
		if (eb.isDemolished) {
			// Add to demolish list
			const li = document.createElement('li');
			li.className = 'list-item-justify';
			li.dataset.buildingId = eb.id;
			
			const span = document.createElement('span');
			span.innerHTML = eb.descriptionHTML;
			
			const button = document.createElement('button');
			button.type = 'button';
			button.classList.add('btn');
			button.innerHTML = `<i class="bi bi-x-lg"></i>`;
			
			if (eb.size > data.unoccupiedTiles) {
				button.disabled = true;
			} else {
				button.addEventListener('click', () => {
					eb.isDemolished = false;
					updateUI();
				});
			}
			
			li.appendChild(span);
			li.appendChild(button);
			elements.demolish.appendChild(li);
		} else {
			// Add to existing buildings list
			const div = document.createElement('div');
			div.className = 'form-check';
			
			const input = document.createElement('input');
			input.id = 'demolish_' + eb.id;
			input.className = 'form-check-input';
			input.type = 'checkbox';
			input.dataset.buildingId = eb.id;
			
			const label = document.createElement('label');
			label.htmlFor = input.id;
			label.className = 'form-check-label';
			label.innerHTML = eb.descriptionHTML;
			
			div.appendChild(input);
			div.appendChild(label);
			elements.existingBuildings.appendChild(div);
		}
	});
	
	if (elements.demolish.children.length === 0) {
		elements.demolish.classList.add('d-none');
	} else {
		elements.demolish.classList.remove('d-none');
	}
}

function renderConstructList() {
	const elements = turn.page.elements;
	const data = turn.page.data;
	
	elements.construct.innerHTML = '';
	
	data.newBuildings.forEach((nb, index) => {
		// Add to construct list
		const li = document.createElement('li');
		li.className = 'list-item-justify';
		li.dataset.buildingId = 'nb_' + index; // temporary id
		
		const span = document.createElement('span');
		span.innerHTML = nb.descriptionHTML;
		
		const button = document.createElement('button');
		button.type = 'button';
		button.classList.add('btn');
		button.innerHTML = `<i class="bi bi-x-lg"></i>`;
		
		button.addEventListener('click', () => {
			data.newBuildings.splice(index, 1);
			updateUI();
		});
		
		li.appendChild(span);
		li.appendChild(button);
		elements.construct.appendChild(li);
	});
	
	if (elements.construct.children.length === 0) {
		elements.construct.classList.add('d-none');
	} else {
		elements.construct.classList.remove('d-none');
	}
}

function renderUnoccupiedTiles() {
	const elements = turn.page.elements;
	const data = turn.page.data;
	
	elements.unoccupiedTiles.textContent = data.unoccupiedTiles;
}

//--- DOM content loaded ------------------------------------------------------------------------//
document.addEventListener('DOMContentLoaded', () => {
	turn.page.initialize();
});
</script>